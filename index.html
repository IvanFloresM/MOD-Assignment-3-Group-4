<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs–– -->
  <meta charset="utf-8">
  <title>MoD Group Project</title>
  <meta name="description" content="">
  <meta name="Ivan Flores Martinez" content="">

  <!-- Mobile Specific Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT -->
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/all.min.css">

  <!-- Mobile Specific Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- CSS -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="css/customize.css">

  <!-- Load d3.js -->
  <script src="https://d3js.org/d3.v4.js"></script>
  <!-- D3 v3 -->
  <script src="underscore-min.js"></script>
  <script src="gistfile1.js"></script>
  <!-- Color Scale https://rawgit.com/sghall/7859113/raw/422da4401f7d4fc0352a7c49961d24f03716be7a/gistfile1.js-->
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

  <!-- Mapbox links -->

  <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">

  <style>
    .imgContainer{
      float:left;
      margin-right:5px;
    }

    .text{
    text-align:justify;
    }

    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
    }

    .center-text {
      margin-left: auto;
      margin-right: auto;
      width: 100%;
    }

    .axis .domain {
      display: none;
    }

  </style>

</head>
<body>
  <div class="container one-bottom" style="margin-top: 50px">
    <div class="ten columns">
      <h3 class="text"><STRONG>The impact of COVID-19 on New York City Bike </h3></STRONG>
      <p>
        Mobility on Demand Systems: Data-Driven Analysis, Simulation, Visualization
        <br>
        ARCH 6306/6050, DSBA 6010, ITIS 8010/6010: Wednesdays 6pm-8:30pm, Taught Online
        <br>
        Team: Ivan Flores Martinez, Bianca Moore, Jake D'Antoni, Samrhiti Kamat
        <br>
        Advisor: Dr. Dimitris Papanikolaou | dpapanik@uncc.edu | Urban Synergetics Lab | https://urbansynergeticslab.net
      </p>
    </div>
    <div class="two columns">
      <a href="https://urbansynergeticslab.net/"><img class="scale-with-grid" src="images/LabLogo_dark_cropped.png"></strong></a>
    </div>
    <div class="twelve columns">
      <h5>Research Question</h5>
      <h4 class="text"><strong>How have the peak hours and numbers of trips effected demand of the city bikes in NYC in 2020?</h4>


      <h5 style="text-align: center"><em>Bike lanes and stations</em></h5>
      <div id='map' style='width: 950px; height: 500px; align=middle;'> </div>
      <p class="center-text">
      The map above introduces the data of the project; Bike sharing systems in NYC. It showcases the bike sharing stations and lanes of NYC that were considered in the project. In the map, the red represents stations in 2019 and the yellow represents stations that were created in 2020.</p>
      <br>


      <h5>Background</h5>
      <p class="text">With the recent outbreak of the coronavirus pandemic in 2020, we aim to compare data on bike sharing services in New York City from the years 2019 and 2020 to see if there are any conclusions that can be drawn relating to the pandemic’s effect on the CitiBike NYC services. Although correlation does not prove causation, we believe that examining these two years and comparing the data will allow us to make assumptions based on the data found. </p>


    </div>
      <div class="image123">
        <div class="imgContainer">
          <p class="center"><em>Covid cases vs number of trips in NYC in 2020</em></p>
          <img src="images/Trips vs Case Count.png" height="470" width="470"/>
        </div>
        <div class="imgContainer">
          <p class="center"><em>Covid cases in New York City in 2020</em></p>
          <img class="middle-img" src="images/dates vs cases.png" height="470" width="470"/>
        </div>
      </div>
      <br>
    <br>
    <br>

      <p class="text">The data that was collected and observed included variables relating to location, time, number of trips and user type. COVID-19 shutdowns began in March of 2020 in the state of New York. The number of COVID-19 cases in NYC today amount to over 676,000 with over 28,000 deaths. Due to the amount of cases in NYC, we found it important to determine the effects of the pandemic on the city's shared bike system. We collected data from New York Public Health repository and added it to our analysis to observe impact.With our question in specific we aimed at looking at location and the timeline of the trips. On looking at the graphs concerning peak hours, it is observed that not only did the peak hours fluctuate but also the number of trips varied. Conclusions can be drawn relating to the number of trips, where there was a sharp decrease in March & April of 2020 when national lockdown began.</p>
    
      <div>
        <p class="center"><em>Mobility trends in 2020 and 2021</em></p>
      <img class="middle-img" src="images/time series of mobility.png" height="600" width="1000" align="middle"/></div>
      </br>

      <p class="text">The time series graph compares mobility trends from January 2020 to March 2021. Considering the lockdown due to the Covid-19 a severe dip was observed in all the three modes of transport in March 2020. Post March 2020 an increase in mobility was observed with driving being at the highest. It can also be observed that the use of transit systems showed a consistent increase post the lockdown of March 2020.</p>


 <p class="center"><em>Number of trips in NYC in 2020 and 2019</em></p>
    <div id="my_dataviz" align="middle" class="center"></div>
    <div class="twelve columns">
    <p class="text"> As compared to 2019 the number of trips in NYC drastically decreased in the month of March 2020 due to the lockdown the city faced. However, the overall trend between the years was not affected significantly. As the city went in phase 1 and 2 of the virus outbreak the usage of the Bike Sharing system seemed to have increased again. The number of trips in the month of october 2019 and 2020 seemed to be similar which concludes that the city went back to routine and utility in the later months of the year 2020.</p>
    </div>
    </br>


        <div>
      <p class="center"><em>March 2019 vs 2020</em></p>
      <img class="middle-img" src="images/march month 2019 vs 2020.png" height="600" width="1000" align="middle"/></div>
    <br>

    <p class="text">The average number of trips per hour shows that in 2019, there were two peaks - in the morning at 6am and in the evening at 5pm. This alludes to the conclusion that shared bike systems were used for commuting to and from work. Comparatively, the data from 2020 shows the dip in the usage of morning and afternoon peak in trips, possibly due to change in working patterns and transition to working-from-home. As seen in the graphs, the patterns show the usage reduced but with a lesser intensity concluding that people continued to use shared bike systems for mobility not just for work but also for leisure purposes.</p>
    </br>



      <p class="center" >"Trip duration in 2019 vs 2020"</p>

      <div>
      <div id="chart2"></div>
      </br>


      <div>
      <div id="chart1"></div>
      </div>
      </br>
      </br>

      <p class="text">The graph compares the trip durations grouped by minutes of the CitiBike in NYC in the years 2019 and 2020. It can be noted that not only did the number of trips decline but also did the duration of trips. Shorter trips were observed in 2020 as compared to 2019</p>


       <div>
      <div class="imgContainer" id="chart4"></div>
      </br>


      <div>
      <div class="imgContainer" id="chart5"></div>
      </div>
      </br>
      </br>

      <p class="text">The graphs above compare trip durations between the months of January and June in the year of 2019 and 2020. Even though, during 2020 the trip count decreased for both the genders in the month of March and April, trips taken by men remained higher than women.</p>
      <br>
      </br>

        <div>
      <div class="imgContainer" id="chart6"></div>
      </br>


      <div>
      <div class="imgContainer" id="chart7"></div>
      </div>
      </br>
      </br>

      <p class="text">The graphs above, compare the number of rides based on customer type in 2019 and 2020 from the months between January and June. In both the years there is a clear trend of subscribers being higher than the non-subscribers, the subscription rate decreased from 2019 and 2020.In 2019, the graph describes an incline in the number of subscriber rides but in 2020, a dip in the usage is observed in the months of March and April. It can be assumed that this decline can be caused due to the lockdown the city went through in 2020 due to COVID-19. However, the number of rides seemed to pick up again post lockdown. Another distinct change in trend observed from 2019 to 2020 is the number of non-subscribers seemed to increase in 2020. Though these observations, we can see that subscriptions began to decline during the COVID-19 outbreak and non-subscribers increased in 2020.</p>
      <br>
      </br>
    
   


    <div>
      <p class="center"><em>Top 10 start in 2019</em></p>
      <img class="middle-img" src="images/top10 stations 2019.png" height="600" width="1000" align="middle"/></div>
      <br>

        <div>
      <p class="center"><em>Top 10 stations in 2020</em></em></p>
      <img class="middle-img" src="images/top10 stations 2020.png" height="600" width="1000" align="middle"/></div>
      <br>
      <p class="text">The graph depicts significant differences between the years 2019 and 2020 as the usage of bikes by females decreased in peak hour values. Broadway and East 22 St. station specifically used by female users  was seen to have a decrease in the no. of trips from 2019 to 2020. Men were observed to use the Bike Sharing system more frequently as compared to women in both the years.</p>
    </br>


    <div class="twelve columns">
	<p class="center"><em>Top 60 stations in 2019</em></p></div>
	<div class="imgContainer">
		<div id="tooltip" align="middle"></div>
	<br>

    <div id="tooltip2" align="middle"></div>
    <br>

	<p class="center"><em>Top 60 stations in 2020</em></p>
    <p>The chord diagram represents connections between the top 60 stations in 2019 and 2020. The interconnections between stations are the trips made between the stations. Compared to 2019, interconnectivity decreased between stations. One explanation of this behavior is that the number of commuters decreased in 2020 while the number of recreational bike users increased. In addition, bike users also made shorter trips in 2020.</p>
    </br>


     


  </div>
      <div class="image123">
        <div class="imgContainer">
          <p class="center"><em>Top Stations 2019</em></p>
          <iframe src="https://kepler.gl/demo/map?mapUrl=https://dl.dropboxusercontent.com/s/ntdt0h3ukqh8t9x/keplergl_ijbiwds.json" style="border:0px #ffffff none;" name="myiFrame" scrolling="no" frameborder="1" marginheight="0px" marginwidth="0px" height="600px" width="470px" allowfullscreen></iframe>
        </div>
        <div class="imgContainer">
          <p class="center"><em>Top Stations 2020</em></p>
          <iframe src="https://kepler.gl/demo/map?mapUrl=https://dl.dropboxusercontent.com/s/1ac83awmx30iidf/keplergl_ld6mth9.json" style="border:0px #ffffff none;" name="myiFrame" scrolling="no" frameborder="1" marginheight="0px" marginwidth="0px" height="600px" width="470px" allowfullscreen></iframe>
        </div>
      <br>
      <div><br></div>
    
      </br>
  <div class="twelve columns">
      <p class="text"> The maps above represent the top ten stations identified by how frequently they were used as end stations and the height specifies the exact number of trips made in the year 2019 and 2020. The density of end stations is shown by the array of circles with density ranging from more trips (yellow) to less trips (purple). On comparing the two maps above, it can be observed that from the year 2019 to 2020, not only did the highest number of trips drop by 33% but also the densities of stations most frequently used changed. While the top stations with most densities were observed to be more clustered in the center of Manhattan, Midtown in 2019, the top stations in 2020 were observed to be more scattered and towards the waterfront edges between New York and New Jersey, popular parks and recreational squares. The top station of 2019 was in the middle of Manhattan, in the core of commercial areas of Midtown and a contrast to that was the top station of 2020 i.e., the upper east side station. Using these observations, a conclusion can be made that people chose the Bike Sharing system for recreational activities in 2020 as compared to 2019, where they only commuted for work into the core of the city.</p></div>
      <br>




  <div class="twelve columns">
      <h5 style="text-align: center"><em>Land use</em></h5>
      <div id='map2' style='width: 950px; height: 500px; align=middle;'> </div>
      <p class="text"> The map above compares the Bike Sharing stations in the year 2019 and 2020, with a layer of land use pattern of NYC showing the manufacturing & commercial districts in comparison with residential areas. While the red and yellow circles represent the top ten stations used in the year 2019 and 2020 respectively, the black circles represent the stations which remained to be popular throughout the two years. It can be observed that new popular stations arose in areas which were less commercial. With this observation it can be said that people still used the Bike Sharing systems even with the COVID-19 outbreak and lockdown, but this time more for leisure than for work. Another distinction that could be made from the map was that in 2020, the top 10 stations were farther away from the subway lines. This change could have been caused as people avoided crowded places such as the subways due to COVID-19.</p></div>
      <br>

     </div>
      <div class="image123">
        <div class="imgContainer">
          <p class="center"><em>Weekend/Weekday 2019</em></p>
          <iframe src="https://kepler.gl/demo/map?mapUrl=https://dl.dropboxusercontent.com/s/126hkuaepzh2izp/keplergl_y60pdn39.json" style="border:0px #ffffff none;" name="myiFrame" scrolling="no" frameborder="1" marginheight="0px" marginwidth="0px" height="600px" width="470px" allowfullscreen></iframe>
        </div>
        <div class="imgContainer">
          <p class="center"><em>Weekend/Weekday 2020</em></p>
          <iframe src="https://kepler.gl/demo/map?mapUrl=https://dl.dropboxusercontent.com/s/o5p4j3sakvwxioc/keplergl_wdakquo.json" style="border:0px #ffffff none;" name="myiFrame" scrolling="no" frameborder="1" marginheight="0px" marginwidth="0px" height="600px" width="470px" allowfullscreen></iframe>
        </div>
      <br>
      <br>      

      <div class="twelve columns">
      <p class="text"> The hexagons in the map above represent stations in a 0.3-mile radius each and the colors red and yellow represent trips taken more on weekends and weekdays respectively in the year 2019 and 2020.On comparison of the two maps, a clear rise in the number of trips taken on the weekend can be observed in 2020 than 2019. While in 2019, it can be noted that people used the Bike sharing systems on the weekends near recreational areas like the Central park, in 2020 people used bikes not just around the popular parks and squares but also around the commercial areas of the city too.</p></div>
      <br>

      <div class="twelve columns">
      <p class="text"> General conclusions regarding the change in bike share programs due to the COVID-19 pandemic point towards the following assumptions:</p></div>
        <div class="twelve columns">
          <ol>
             <li class="text"> Less subscribers and more casual user in 2020.</li>
             <li class="text"> Shorter trips and more round trips in 2020.</li>
             <li class="text"> Most popular location changed from business areas to other areas.</li> 
             <li class="text"> Less commuter trips and more recreational trips in 2020.</li>
            </ol>
        </div>
      <br>


      <h3>References</h3>
      <ol>
        <li class="text">Hu, Winnie. “A Surge in Biking to Avoid Crowded Trains in N.Y.C.” The New York Times. The New York Times, March 14, 2020. https://www.nytimes.com/2020/03/14/nyregion/coronavirus-nyc-bike-commute.html</li>
        <li class="text">Calgary, Open. “Bicycle Routes.” NYC Open Data. Accessed February 17, 2021. https://data.cityofnewyork.us/Transportation/Bicycle-Routes/7vsa-caz7.</li>
        <li class="text">Tedeschi, Alexander. “Rebalancing Citi Bike : a Geospatial Analysis of Bike Share Redistribution in New York City.” RUN, February 26, 2016. https://run.unl.pt/handle/10362/17842?locale=en.</li>
        <li class="text">Teixeira, João Filipe, and Miguel Lopes. “The Link between Bike Sharing and Subway Use during the COVID-19 Pandemic: The Case-Study of New York's Citi Bike.” Transportation Research Interdisciplinary Perspectives. Elsevier, July 8, 2020. https://www.sciencedirect.com/science/article/pii/S2590198220300774.</li>
        <li class="text">Apple mobility trends 2020-2021.</li>
      </ol>
    </div>
  </div>

  <div class="twelve columns">
    <h3>Team & Contributions</h3>
    <h5>Ivan Flores Martinez</h5>
    <p class="text">Ivan Flores took the lead with regards to setting up the github website, cleaning data, and creating chord graphs, scatterplots, and stacked bar graphs in D3 for the webpage. He also aided in putting together the github website.</p>
    <h5>Bianca Moore</h5>
    <p class="text">Bianca Moore contributed graphs for analyses, exports for assisting with map discovery. She aided putting together the github website.</p>
    <h5>Jake D'Antoni</h5>
    <p class="text">Jake D'Antoni produced the bike sharing maps via Kepler and Mapbox and cleaned the data for the assignment. He also aided in putting together the github website.</p>
    <h5>Samrhiti Kamat</h5>
    <p class="text">Samrhiti Kamat produced the content to the graphs and maps in the website. She aided putting together the github website.</p>
  </div>
</body>

/// Mapbox code
/// Map 1
 <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiamNkYW50b25pIiwiYSI6ImNrbDc5aGFxcjFrM2wydm5yZWthajFpc3UifQ.Y3ZOqGUxmeVLmvfiUSLVDw';
    var map = new mapboxgl.Map({
    container: 'map', // container ID
    style: 'mapbox://styles/jcdantoni/ckl42vtzl2zrp17jy6oxr56k8', // style URL
    center: [-74, 40.72165072], // starting position [lng, lat]
    zoom: 11 // starting zoom
  });
  </script>

/// Map 1
 <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiamNkYW50b25pIiwiYSI6ImNrbDZ6OGI2azFuM24ycHFtd3Nsazd3cnQifQ.RxXx9iFbnn3w4Z9_78DX_Q';
    var map2 = new mapboxgl.Map({
    container: 'map2', // container ID
    style: 'mapbox://styles/jcdantoni/cknaqw17h17gh17o6qpwy8vfx', // style URL
    center: [-74, 40.72165072], // starting position [lng, lat]
    zoom: 11 // starting zoom
  });
  </script>




<script>
  // set the dimensions and margins of the graph
  var margin = {top: 10, right: 100, bottom: 30, left: 30},
          width = 1100 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

  // append the svg object to the body of the page
  var svg = d3.select("#my_dataviz")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");

  //Read the data
  d3.csv("data/trips_2019-2020.csv", function(data) {

    // List of groups (here I have one group per column)
    var allGroup = ["trips2019", "trips2020", "total_trips"]

    // Reformat the data: we need an array of arrays of {x, y} tuples
    var dataReady = allGroup.map( function(grpName) { // .map allows to do something for each element of the list
      return {
        name: grpName,
        values: data.map(function(d) {
          return {month: d.month, value: +d[grpName]};
        })
      };
    });
    // I strongly advise to have a look to dataReady with
    // console.log(dataReady)

    // A color scale: one color for each group
    var myColor = d3.scaleOrdinal()
            .domain(allGroup)
            .range(d3.schemeSet2);

    // Add X axis --> it is a date format
    var x = d3.scaleLinear()
            .domain([0,12])
            .range([ 0, width ]);
    svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

    // Add Y axis
    var y = d3.scaleLinear().nice()
            .domain([0, 100000])
            .range([ height,0]);
    svg.append("g")
            .call(d3.axisLeft(y));
//    d3.axisLeft(y)).tickValues([10000,20000,30000,40000,50000,60000,70000,80000,90000, 10000]);

    // Add the lines
    var line = d3.line()
            .x(function(d) { return x(+d.month) })
            .y(function(d) { return y(+d.value) })
    svg.selectAll("myLines")
            .data(dataReady)
            .enter()
            .append("path")
            .attr("class", function(d){ return d.name })
            .attr("d", function(d){ return line(d.values) } )
            .attr("stroke", function(d){ return myColor(d.name) })
            .style("stroke-width", 4)
            .style("fill", "none")

    // Add the points
    svg
            // First we need to enter in a group
            .selectAll("myDots")
            .data(dataReady)
            .enter()
            .append('g')
            .style("fill", function(d){ return myColor(d.name) })
            .attr("class", function(d){ return d.name })
            // Second we need to enter in the 'values' part of this group
            .selectAll("myPoints")
            .data(function(d){ return d.values})
            .enter()
            .append("circle")
            .attr("cx", function(d) { return x(d.month) } )
            .attr("cy", function(d) { return y(d.value) } )
            .attr("r", 8)
            .attr("stroke", "white")

    // Add a label at the end of each line
    svg
            .selectAll("myLabels")
            .data(dataReady)
            .enter()
            .append('g')
            .append("text")
            .attr("class", function(d){ return d.name })
            .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; }) // keep only the last value of each time series
            .attr("transform", function(d) { return "translate(" + x(d.value.month) + "," + y(d.value.value) + ")"; }) // Put the text at the position of the last point
            .attr("x", 12) // shift the text a bit more right
            .text(function(d) { return d.name; })
            .style("fill", function(d){ return myColor(d.name) })
            .style("font-size", 20)

    // Add a legend (interactive)
    svg
            .selectAll("myLegend")
            .data(dataReady)
            .enter()
            .append('g')
            .append("text")
            .attr('x', function(d,i){ return 30 + i*130})
            .attr('y', 10)
            .text(function(d) { return d.name; })
            .style("fill", function(d){ return myColor(d.name) })
            .style("font-size", 20)
            .on("click", function(d){
              // is the element currently visible ?
              currentOpacity = d3.selectAll("." + d.name).style("opacity")
              // Change the opacity: from 0 to 1 or from 1 to 0
              d3.selectAll("." + d.name).transition().style("opacity", currentOpacity == 1 ? 0:1)

            })
  })
</script>

 <script>
        d3.csv('data/data_2019.csv', function(error, data) {
            var mpr = chordMpr(data);
            mpr
                .addValuesToMap('root')
                .addValuesToMap('node')
                .setFilter(function(row, a, b) {
                    return (row.root === a.name && row.node === b.name)
                })
                .setAccessor(function(recs, a, b) {
                    if (!recs[0]) return 0;
                    return +recs[0].count;
                });
            drawChords(mpr.getMatrix(), mpr.getMap());
        });

        function drawChords(matrix, mmap) {

            var w = 800,
                h = 700,
                r1 = h / 2,
                r0 = r1 - 110;

            var chord = d3.chord()
                .padAngle(0.05)
                .sortSubgroups(d3.descending)
                .sortChords(d3.descending);

            var arc = d3.arc()
                .innerRadius(r0)
                .outerRadius(r0 + 20);

            var ribbon = d3.ribbon()
                .radius(r0);

            var svg = d3.select("#tooltip").append("svg:svg")
                .attr("width", w)
                .attr("height", h)
                .append("svg:g")
                .attr("id", "circle")
                .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")")
                .datum(chord(matrix));

            svg.append("circle")
                .attr("r", r0 + 20);

            var mapReader = chordRdr(matrix, mmap);


            var g = svg.selectAll("g.group")
                .data(function(chords) {
                    return chords.groups;
                })
                .enter().append("svg:g")
                .attr("class", "group")

            g.append("svg:path")
                .style("stroke", "grey")
                .style("fill", function(d) {
                    return mapReader(d).gdata;
                })
                .attr("d", arc);

            g.append("svg:text")
                .each(function(d) {
                    d.angle = (d.startAngle + d.endAngle) / 2;
                })
                .attr("dy", ".35em")
                .style("font-family", "helvetica, arial, sans-serif")
                .style("font-size", "9px")
                .attr("text-anchor", function(d) {
                    return d.angle > Math.PI ? "end" : null;
                })
                .attr("transform", function(d) {
                    return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
                        "translate(" + (r0 + 26) + ")" +
                        (d.angle > Math.PI ? "rotate(180)" : "");
                })
                .text(function(d) {
                    return mapReader(d).gname;
                });

            var colors = d3.scaleOrdinal(d3.schemeCategory20c);

            var chordPaths = svg.selectAll("path.chord")
                .data(function(chords) {
                    return chords;
                })
                .enter().append("svg:path")
                .attr("class", "chord")
                .style("stroke", "grey")
                .style("fill", function(d, i) {
                    return colors(i)
                })
                .attr("d", ribbon.radius(r0))

        }
    </script>

<script>
        d3.csv('data/data_2020.csv', function(error, data) {
            var mpr = chordMpr(data);
            mpr
                .addValuesToMap('root')
                .addValuesToMap('node')
                .setFilter(function(row, a, b) {
                    return (row.root === a.name && row.node === b.name)
                })
                .setAccessor(function(recs, a, b) {
                    if (!recs[0]) return 0;
                    return +recs[0].count;
                });
            drawChords(mpr.getMatrix(), mpr.getMap());
        });

        function drawChords(matrix, mmap) {

            var w = 800,
                h = 700,
                r1 = h / 2,
                r0 = r1 - 110;

            var chord = d3.chord()
                .padAngle(0.05)
                .sortSubgroups(d3.descending)
                .sortChords(d3.descending);

            var arc = d3.arc()
                .innerRadius(r0)
                .outerRadius(r0 + 20);

            var ribbon = d3.ribbon()
                .radius(r0);

            var svg = d3.select("#tooltip2").append("svg:svg")
                .attr("width", w)
                .attr("height", h)
                .append("svg:g")
                .attr("id", "circle")
                .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")")
                .datum(chord(matrix));

            svg.append("circle")
                .attr("r", r0 + 20);

            var mapReader = chordRdr(matrix, mmap);


            var g = svg.selectAll("g.group")
                .data(function(chords) {
                    return chords.groups;
                })
                .enter().append("svg:g")
                .attr("class", "group")

            g.append("svg:path")
                .style("stroke", "grey")
                .style("fill", function(d) {
                    return mapReader(d).gdata;
                })
                .attr("d", arc);

            g.append("svg:text")
                .each(function(d) {
                    d.angle = (d.startAngle + d.endAngle) / 2;
                })
                .attr("dy", ".35em")
                .style("font-family", "helvetica, arial, sans-serif")
                .style("font-size", "9px")
                .attr("text-anchor", function(d) {
                    return d.angle > Math.PI ? "end" : null;
                })
                .attr("transform", function(d) {
                    return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
                        "translate(" + (r0 + 26) + ")" +
                        (d.angle > Math.PI ? "rotate(180)" : "");
                })
                .text(function(d) {
                    return mapReader(d).gname;
                });

            var colors = d3.scaleOrdinal(d3.schemeCategory20c);

            var chordPaths = svg.selectAll("path.chord")
                .data(function(chords) {
                    return chords;
                })
                .enter().append("svg:path")
                .attr("class", "chord")
                .style("stroke", "grey")
                .style("fill", function(d, i) {
                    return colors(i)
                })
                .attr("d", ribbon.radius(r0))

        }
    </script>

<script>
var svg1 = d3.select("#chart1").append("svg").attr("width", 450).attr("height", 500),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = +svg1.attr("width") - margin.left - margin.right,
    height = +svg1.attr("height") - margin.top - margin.bottom,
    g1 = svg1.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// set x scale
var x = d3.scaleBand()
    .rangeRound([0, width])
    .paddingInner(0.05)
    .align(0.1);

// set y scale
var y = d3.scaleLinear()
    .rangeRound([height, 0]);

// set the colors
var z = d3.scaleOrdinal()
    .range(["#fd1212", "#c3ce1a"]);

// load the csv and create the chart
d3.csv("data/age-groups.csv", function(d, i, columns) {
  for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
  d.total = t;
  return d;
}, function(error, data) {
  if (error) throw error;

  var keys = data.columns.slice(1);

  
  x.domain(data.map(function(d) { return d.State; }));
  y.domain([0, d3.max(data, function(d) { return d.total; })]).nice();
  z.domain(keys);

  g1.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("x", function(d) { return x(d.data.State); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); })
      .attr("width", x.bandwidth())
    .on("mouseover", function() { tooltip1.style("display", null); })
    .on("mouseout", function() { tooltip1.style("display", "none"); })
    .on("mousemove", function(d) {
      console.log(d);
      var xPosition1 = d3.mouse(this)[0] - 5;
      var yPosition1 = d3.mouse(this)[1] - 5;
      tooltip1.attr("transform", "translate(" + xPosition1 + "," + yPosition + ")");
      tooltip1.select("text").text(d[1]-d[0]);
    });

  g1.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x1));

  g1.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y1).ticks(null, "s"))
    .append("text")
      .attr("x", 2)
      .attr("y", y(y1.ticks().pop()) + 0.5)
      .attr("dy", "0.32em")
      .attr("fill", "#000")
      .attr("font-weight", "bold")
      .attr("text-anchor", "start");

  var legend2 = g1.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 12)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(keys.slice().reverse())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(10," + i * 20 + ")"; });

  legend2.append("rect")
      .attr("x", width - 19)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z);

  legend2.append("text")
      .attr("x", width - 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d; });
});

  // Prep the tooltip bits, initial display is hidden
  var tooltip1 = svg1.append("g")
    .attr("class", "tooltip")
    .style("display", "none");
      
  tooltip1.append("rect")
    .attr("width", 60)
    .attr("height", 20)
    .attr("fill", "white")
    .style("opacity", 0.5);

  tooltip1.append("text")
    .attr("x", 30)
    .attr("dy", "1.2em")
    .style("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-weight", "bold");

</script>

<style>
        .axis--x path {
            display: none;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }
    </style>

<script>
// create the svg
var svg4 = d3.select("#chart4").append("svg").attr("width", 450).attr("height", 500),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width4 = +svg4.attr("width") - margin.left - margin.right,
    height4 = +svg4.attr("height") - margin.top - margin.bottom,
    g4 = svg4.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// set x scale
var x4 = d3.scaleBand()
    .rangeRound([0, width4])
    .paddingInner(0.05)
    .align(0.1);

// set y scale
var y4 = d3.scaleLinear()
    .rangeRound([height4, 0]);

// set the colors
var z4 = d3.scaleOrdinal()
    .range(["#fd1212", "#edfb0f"]);

// load the csv and create the chart
d3.csv("data/age-groups2.csv", function(d, i, columns) {
  for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
  d.total = t;
  return d;
}, function(error, data) {
  if (error) throw error;

  var keys4 = data.columns.slice(1);

  x4.domain(data.map(function(d) { return d.State; }));
  y4.domain([0, d3.max(data, function(d) { return d.total; })]).nice();
  z4.domain(keys4);

  g4.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys4)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("x", function(d) { return x(d.data.State); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); })
      .attr("width", x4.bandwidth())
    .on("mouseover", function() { tooltip4.style("display", null); })
    .on("mouseout", function() { tooltip4.style("display", "none"); })
    .on("mousemove", function(d) {
      console.log(d);
      var xPosition4 = d3.mouse(this)[0] - 5;
      var yPosition4 = d3.mouse(this)[1] - 5;
      tooltip4.attr("transform", "translate(" + xPosition4 + "," + yPosition4 + ")");
      tooltip4.select("text").text(d[1]-d[0]);
    });

  g4.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height4 + ")")
      .call(d3.axisBottom(x4));

  g4.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y4).ticks(null, "s"))
    .append("text")
      .attr("x", 2)
      .attr("y", y(y4.ticks().pop()) + 0.5)
      .attr("dy", "0.32em")
      .attr("fill", "#000")
      .attr("font-weight", "bold")
      .attr("text-anchor", "start");

  var legend4 = g4.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(keys4.slice().reverse())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend4.append("rect")
      .attr("x", width4 - 19)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z4);

  legend4.append("text")
      .attr("x", width4 - 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d; });
});

  // Prep the tooltip bits, initial display is hidden
  var tooltip4 = svg4.append("g")
    .attr("class", "tooltip")
    .style("display", "none");
      
  tooltip4.append("rect")
    .attr("width", 60)
    .attr("height", 20)
    .attr("fill", "white")
    .style("opacity", 0.5);

  tooltip4.append("text")
    .attr("x", 30)
    .attr("dy", "1.2em")
    .style("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-weight", "bold");
</script>


<script>
// create the svg
var svg5 = d3.select("#chart5").append("svg").attr("width", 450).attr("height", 500),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width5 = +svg5.attr("width") - margin.left - margin.right,
    height5 = +svg5.attr("height") - margin.top - margin.bottom,
    g5 = svg5.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// set x scale
var x5 = d3.scaleBand()
    .rangeRound([0, width5])
    .paddingInner(0.05)
    .align(0.1);

// set y scale
var y5 = d3.scaleLinear()
    .rangeRound([height5, 0]);

// set the colors
var z5 = d3.scaleOrdinal()
    .range(["#fd1212", "#edfb0f"]);

// load the csv and create the chart
d3.csv("data/age-groups3.csv", function(d, i, columns) {
  for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
  d.total = t;
  return d;
}, function(error, data) {
  if (error) throw error;

  var keys5 = data.columns.slice(1);

  x5.domain(data.map(function(d) { return d.State; }));
  y5.domain([0, d3.max(data, function(d) { return d.total; })]).nice();
  z5.domain(keys5);

  g5.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys5)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("x", function(d) { return x(d.data.State); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); })
      .attr("width", x5.bandwidth())
    .on("mouseover", function() { tooltip5.style("display", null); })
    .on("mouseout", function() { tooltip5.style("display", "none"); })
    .on("mousemove", function(d) {
      console.log(d);
      var xPosition5 = d3.mouse(this)[0] - 5;
      var yPosition5 = d3.mouse(this)[1] - 5;
      tooltip5.attr("transform", "translate(" + xPosition5 + "," + yPosition5 + ")");
      tooltip5.select("text").text(d[1]-d[0]);
    });

  g5.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height5 + ")")
      .call(d3.axisBottom(x5));

  g5.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y5).ticks(null, "s"))
    .append("text")
      .attr("x", 2)
      .attr("y", y(y4.ticks().pop()) + 0.5)
      .attr("dy", "0.32em")
      .attr("fill", "#000")
      .attr("font-weight", "bold")
      .attr("text-anchor", "start");

  var legend5 = g5.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(keys5.slice().reverse())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend5.append("rect")
      .attr("x", width5 - 19)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z4);

  legend5.append("text")
      .attr("x", width5 - 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d; });
});

  // Prep the tooltip bits, initial display is hidden
  var tooltip5 = svg5.append("g")
    .attr("class", "tooltip")
    .style("display", "none");
      
  tooltip5.append("rect")
    .attr("width", 60)
    .attr("height", 20)
    .attr("fill", "white")
    .style("opacity", 0.5);

  tooltip5.append("text")
    .attr("x", 30)
    .attr("dy", "1.2em")
    .style("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-weight", "bold");
</script>


<script>
// create the svg
var svg6 = d3.select("#chart6").append("svg").attr("width", 450).attr("height", 500),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width6 = +svg6.attr("width") - margin.left - margin.right,
    height6 = +svg6.attr("height") - margin.top - margin.bottom,
    g6 = svg6.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// set x scale
var x6 = d3.scaleBand()
    .rangeRound([0, width6])
    .paddingInner(0.05)
    .align(0.1);

// set y scale
var y6 = d3.scaleLinear()
    .rangeRound([height6, 0]);

// set the colors
var z6 = d3.scaleOrdinal()
    .range(["#fd1212", "#edfb0f"]);

// load the csv and create the chart
d3.csv("data/age-groups6.csv", function(d, i, columns) {
  for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
  d.total = t;
  return d;
}, function(error, data) {
  if (error) throw error;

  var keys6 = data.columns.slice(1);

  x6.domain(data.map(function(d) { return d.State; }));
  y6.domain([0, d3.max(data, function(d) { return d.total; })]).nice();
  z6.domain(keys6);

  g6.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys6)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("x", function(d) { return x(d.data.State); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); })
      .attr("width", x5.bandwidth())
    .on("mouseover", function() { tooltip6.style("display", null); })
    .on("mouseout", function() { tooltip6.style("display", "none"); })
    .on("mousemove", function(d) {
      console.log(d);
      var xPosition6 = d3.mouse(this)[0] - 5;
      var yPosition6 = d3.mouse(this)[1] - 5;
      tooltip6.attr("transform", "translate(" + xPosition6 + "," + yPosition6 + ")");
      tooltip6.select("text").text(d[1]-d[0]);
    });

  g6.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height6 + ")")
      .call(d3.axisBottom(x6));

  g6.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y6).ticks(null, "s"))
    .append("text")
      .attr("x", 2)
      .attr("y", y(y6.ticks().pop()) + 0.5)
      .attr("dy", "0.32em")
      .attr("fill", "#000")
      .attr("font-weight", "bold")
      .attr("text-anchor", "start");

  var legend6 = g6.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(keys6.slice().reverse())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend6.append("rect")
      .attr("x", width6 - 19)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z6);

  legend6.append("text")
      .attr("x", width6 - 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d; });
});

  // Prep the tooltip bits, initial display is hidden
  var tooltip6 = svg6.append("g")
    .attr("class", "tooltip")
    .style("display", "none");
      
  tooltip6.append("rect")
    .attr("width", 60)
    .attr("height", 20)
    .attr("fill", "white")
    .style("opacity", 0.5);

  tooltip6.append("text")
    .attr("x", 30)
    .attr("dy", "1.2em")
    .style("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-weight", "bold");
</script>


<script>
// create the svg
var svg7 = d3.select("#chart7").append("svg").attr("width", 450).attr("height", 500),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width7 = +svg7.attr("width") - margin.left - margin.right,
    height7 = +svg7.attr("height") - margin.top - margin.bottom,
    g7 = svg7.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// set x scale
var x7 = d3.scaleBand()
    .rangeRound([0, width7])
    .paddingInner(0.05)
    .align(0.1);

// set y scale
var y7 = d3.scaleLinear()
    .rangeRound([height7, 0]);

// set the colors
var z7 = d3.scaleOrdinal()
    .range(["#fd1212", "#edfb0f"]);

// load the csv and create the chart
d3.csv("data/age-groups7.csv", function(d, i, columns) {
  for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
  d.total = t;
  return d;
}, function(error, data) {
  if (error) throw error;

  var keys7 = data.columns.slice(1);

  x7.domain(data.map(function(d) { return d.State; }));
  y7.domain([0, d3.max(data, function(d) { return d.total; })]).nice();
  z7.domain(keys7);

  g7.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys7)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("x", function(d) { return x(d.data.State); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); })
      .attr("width", x7.bandwidth())
    .on("mouseover", function() { tooltip7.style("display", null); })
    .on("mouseout", function() { tooltip7.style("display", "none"); })
    .on("mousemove", function(d) {
      console.log(d);
      var xPosition7 = d3.mouse(this)[0] - 5;
      var yPosition7 = d3.mouse(this)[1] - 5;
      tooltip7.attr("transform", "translate(" + xPosition7 + "," + yPosition7 + ")");
      tooltip7.select("text").text(d[1]-d[0]);
    });

  g7.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height7 + ")")
      .call(d3.axisBottom(x7));

  g7.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y7).ticks(null, "s"))
    .append("text")
      .attr("x", 2)
      .attr("y", y(y7.ticks().pop()) + 0.5)
      .attr("dy", "0.32em")
      .attr("fill", "#000")
      .attr("font-weight", "bold")
      .attr("text-anchor", "start");

  var legend7 = g7.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(keys7.slice().reverse())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend7.append("rect")
      .attr("x", width7 - 19)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z7);

  legend7.append("text")
      .attr("x", width7 - 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d; });
});

  // Prep the tooltip bits, initial display is hidden
  var tooltip7 = svg7.append("g")
    .attr("class", "tooltip")
    .style("display", "none");
      
  tooltip7.append("rect")
    .attr("width", 60)
    .attr("height", 20)
    .attr("fill", "white")
    .style("opacity", 0.5);

  tooltip7.append("text")
    .attr("x", 30)
    .attr("dy", "1.2em")
    .style("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-weight", "bold");
</script>


<script>
// create the svg
var svg3 = d3.select("#chart2").append("svg").attr("width", 450).attr("height", 500),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width3 = +svg3.attr("width") - margin.left - margin.right,
    height3 = +svg3.attr("height") - margin.top - margin.bottom,
    g2 = svg3.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// set x scale
var x2 = d3.scaleBand()
    .rangeRound([0, width])
    .paddingInner(0.05)
    .align(0.1);

// set y scale
var y2 = d3.scaleLinear()
    .rangeRound([height, 0]);

// set the colors
var z2 = d3.scaleOrdinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

// load the csv and create the chart
d3.csv("data/trip_duration.csv", function(d, i, columns) {
  for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
  d.total = t;
  return d;
}, function(error, data) {
  if (error) throw error;

  var keys = data.columns.slice(1);

  data.sort(function(a, b) { return b.total - a.total; });
  x.domain(data.map(function(d) { return d.State; }));
  y.domain([0, d3.max(data, function(d) { return d.total; })]).nice();
  z.domain(keys);

  g2.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("x", function(d) { return x(d.data.State); })
      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); })
      .attr("width", x.bandwidth())
    .on("mouseover", function() { tooltip.style("display", null); })
    .on("mouseout", function() { tooltip.style("display", "none"); })
    .on("mousemove", function(d) {
      console.log(d);
      var xPosition = d3.mouse(this)[0] - 5;
      var yPosition = d3.mouse(this)[1] - 5;
      tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
      tooltip.select("text").text(d[1]-d[0]);
    });

  g2.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height3 + ")")
      .call(d3.axisBottom(x));

  g2.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y).ticks(null, "s"))
    .append("text")
      .attr("x", 2)
      .attr("y", y(y.ticks().pop()) + 0.5)
      .attr("dy", "0.32em")
      .attr("fill", "#000")
      .attr("font-weight", "bold")
      .attr("text-anchor", "start");

  var legend = g2.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(keys.slice().reverse())
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width3 - 19)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z);

  legend.append("text")
      .attr("x", width3 - 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d; });
});

  // Prep the tooltip bits, initial display is hidden
  var tooltip = svg3.append("g")
    .attr("class", "tooltip")
    .style("display", "none");
      
  tooltip.append("rect")
    .attr("width", 60)
    .attr("height", 20)
    .attr("fill", "white")
    .style("opacity", 0.5);

  tooltip.append("text")
    .attr("x", 30)
    .attr("dy", "1.2em")
    .style("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-weight", "bold");

</script>

</html>
